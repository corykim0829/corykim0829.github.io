---
title: "TIL Oct 14th 2019 - LBTATools을 사용하여 CollectionView Header 만들기"
header:
  teaser: /assets/images/til-og.png
  overlay_image: /assets/images/til-og.png
  overlay_filter: 0.2
  caption: "Photo credit: [**Unsplash**](https://unsplash.com)"
categories:
  - TIL
tags:
  - iOS
  - Swift

---



LBTATools 라이브러리를 사용하여 UICollectionView에 Header를 손쉽게 달아보자.



1. 일반적인 Header 등록 방법
2. `LBTATools` 를 사용한 Header 만들기



### 1. 일반적인 Header 등록 방법

UICollectionView에서 일반적으로 Header를 등록하는 방법은 다음과 같다. header와 같은 view들은 collection view에서 `supplementary view`로 분류가 되며 이러한 `supplementary view`를 추가하기 위해서는 `register`라는 collectionView의 method를 이용해서 해당 클래스를 등록해야한다.



> Document

#### register(_:forSupplementaryViewOfKind:withReuseIdentifier:)

Registers a class for use in creating supplementary views for the collection view.

#### Declaration

```
func register(_ viewClass: AnyClass?, forSupplementaryViewOfKind elementKind: String, withReuseIdentifier identifier: String)
```

#### Parameters

- `viewClass`

  The class to use for the supplementary view.

  `UICollectionReusableView` 로 만들어진 class를 넣어주자.

- `elementKind`

  The kind of supplementary view to create. This value is defined by the layout object. This parameter must not be `nil`.

  `UICollectionView.elementKindSectionHeader` 로 입력

- `identifier`

  The reuse identifier to associate with the specified class. This parameter must not be `nil` and must not be an empty string. 

  익숙한 identifier

#### Discussion

Prior to calling the `dequeueReusableSupplementaryView(ofKind:withReuseIdentifier:for:)`method of the collection view, you must use this method or the `register(_:forSupplementaryViewOfKind:withReuseIdentifier:)` method to tell the collection view how to create a supplementary view of the given type. If a view of the specified type is not currently in a reuse queue, the collection view uses the provided information to create a view object automatically. 

If you previously registered a class or nib file with the same element kind and reuse identifier, the class you specify in the `viewClass` parameter replaces the old entry. You may specify `nil` for `viewClass` if you want to unregister the class from the specified element kind and reuse identifier.



> register in viewDidLoad

사용된 parameters는 모두 예시. 사용할 headerView를 register 해주는 과정.

```swift
    override func viewDidLoad() {
        super.viewDidLoad()
        
        collectionView.register(UICollectionReusableView, forSupplementaryViewOfKind: UICollectionView.elementKindSectionHeader, withReuseIdentifier: "headerId")
      ...
```



> viewforsupplementary

register한 headerView(supplementary view)를 duqueuing 작업. dequeuing할 때에는 type casting까지 꼭 해준다.

```swift
    func collectionView(_ collectionView: UICollectionView, viewForSupplementaryElementOfKind kind: String, at indexPath: IndexPath) -> UICollectionReusableView {
        <#code#>
      let header = collectionView.dequeueReusableSupplementaryView(ofKind: kind, withReuseIdentifier: headerId, for: indexPath) as! H
        return header
    }
```



>refsizeforheader

```swift
    func collectionView(_ collectionView: UICollectionView, layout collectionViewLayout: UICollectionViewLayout, referenceSizeForFooterInSection section: Int) -> CGSize {
        <#code#>
    }
```



### 2. `LBTATools` 를 사용한 Header 만들기

[LBTA github](https://github.com/bhlvoong/LBTATools)

위에 필수적인 과정을 `LBTATools` 라이브러리를 사용하면 매번 입력할 필요가 없다. 기존 `UICollectionViewController` 대신에 `LBTAListHeaderController` 를 사용하면 된다.



> class

LBTAListHeaderController를 선언할 때에는 LBTAListController에서 선언할 때 꼭 필요한 LBTAListCell과 Cell에 들어갈 타입인 U, 그리고 Header로 사용할 UICollectionReusableView 이렇게 3개가 필요하다.

```swift
	open class LBTAListHeaderController<T: LBTAListCell<U>, U, H: UICollectionReusableView>: UICollectionViewController
```



{: .notice--note}
Cell의 구성 요소 U는 처음에는 UIColor를 사용하면 기본적으로 잘 rendering 되는지 그리고 요소들의 기본 위치를 정하기에 매우 훌륭하다.



세부 구현 내용

```swift
    open var items = [U]() {
        didSet {
            collectionView.reloadData()
        }
    }
    
    fileprivate let cellId = "cellId"
    fileprivate let headerId = "headerId"
    
    override open func viewDidLoad() {
        super.viewDidLoad()
        collectionView.backgroundColor = .white
        
        collectionView.register(T.self, forCellWithReuseIdentifier: cellId)
        collectionView.register(H.self, forSupplementaryViewOfKind: UICollectionView.elementKindSectionHeader, withReuseIdentifier: headerId)
    }
    
    /// ListHeaderController automatically dequeues your T cell and sets the correct item object on it.
    override open func collectionView(_ collectionView: UICollectionView, cellForItemAt indexPath: IndexPath) -> UICollectionViewCell {
        let cell = collectionView.dequeueReusableCell(withReuseIdentifier: cellId, for: indexPath) as! T
        cell.item = items[indexPath.row]
        cell.parentController = self
        return cell
    }
    
    /// Override this to manually set up your header with custom behavior.
    open func setupHeader(_ header: H) {}
    
    override open func collectionView(_ collectionView: UICollectionView, viewForSupplementaryElementOfKind kind: String, at indexPath: IndexPath) -> UICollectionReusableView {
        let header = collectionView.dequeueReusableSupplementaryView(ofKind: kind, withReuseIdentifier: headerId, for: indexPath) as! H
        setupHeader(header)
        return header
    }
```

Brian형님 멋져요 :clap::clap::clap:



### 3. Header에 collectionViewController 넣기

멋진 앱이라면 하나의 ViewController에 여러개 collectionView가 있다!

header안에 다른 collectionViewController를 넣기 위해 먼저 dummy controller를 넣자. `UIViewController`를 사용해 dummy로 사용가능하다. 



여기에는 LBTAListController사용

{: .notice--note}
LBTAListController의 super class가 LBTAHeaderListController이다.



Cell크기 조절을 위해 `UICollectionViewDelegateFlowLayout` 프로토콜을 사용

> Document

#### UICollectionViewDelegateFlowLayout

The `UICollectionViewDelegateFlowLayout` protocol defines methods that let you coordinate with a [`UICollectionViewFlowLayout`](apple-reference-documentation://hso-HGeVlM) object to implement a grid-based layout. The methods of this protocol define the size of items and the spacing between items in the grid.

마지막 줄 : 이 protocol은 item들의 size와 spacing을 정의하는 메소드들을 제공한다.



### 4. Auto scrolling

#### scrollToItem

In collectionViewController, there is a function for moving scroll of collections. 

```swift
func scrollToItem(at indexPath: IndexPath, at scrollPosition: UICollectionView.ScrollPosition, animated: Bool)
```



Wha you're going to do is scroll to the bottom. items got all cells so you can easily access to last cell using items array.

```swift
self.collectionView.scrollToItem(at: [0, self.items.count - 1], at: .bottom, animated: true)
```



So when you entered chatLogController or send a new message, you need to scroll to the bottom. 

#### notificationCenter

```swift
NotificationCenter.default.addObserver(self, selector: #selector(handleKeyboardShow), name: UIResponder.keyboardDidShowNotification, object: nil)
```



I wanted to add UITapGestureRecognizer to dismiss keyboard when you tap collectionView. But it doesn't work.

```swift
        collectionView.addGestureRecognizer(UITapGestureRecognizer(target: self, action: #selector(handleTapDismiss)))

    @objc fileprivate func handleTapDismiss() {
//        self.collectionView.endEditing(true)
//        self.view.endEditing(true)
    }
```



### 5. Save messages on both users

When you save messages using `addDocument`, you were saving only for current logged user. So receivers can't see all the chat logs. So you need to save a message data both sides 